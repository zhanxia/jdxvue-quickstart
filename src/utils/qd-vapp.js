const e="https://qidianmp.jd.com",t="https://qidianmp.jd.com",n={app:"i",page:"p",event:"e"},r=["pin","openId","unionId"],o="qidian_",s=require("./qd-config.js");var a={makeId(e){let t="";for(;t.length<e;)t+=Math.random().toString(36).substr(2);return`${(new Date).getTime().toString(36)}-${t.substr(0,e)}`.toLocaleUpperCase()},makeKey(e){let t=0;for(let n=0;n<e.length;n+=1)t+=e.charCodeAt(n);return t%=1e3,t},compile(e,t){let n=String.fromCharCode(e.charCodeAt(0)+t);for(let t=1;t<e.length;t+=1)n+=String.fromCharCode(e.charCodeAt(t)+e.charCodeAt(t-1));return escape(n)},uncompile(e,t){const n=unescape(e);let r=String.fromCharCode(n.charCodeAt(0)-t);for(let e=1;e<n.length;e+=1)r+=String.fromCharCode(n.charCodeAt(e)-r.charCodeAt(e-1));return r},joinJson(e){if("Object"===e.constructor.name)return e;const t=e[0];for(let n=e.length-1;n>0;n-=1){const r=Object.keys(e[n]);r.forEach(r=>{t[r]=e[n][r]})}return t},logger(...e){if(s.dev&&"object"===typeof console&&console.log)try{console.log(...e)}catch(t){console.log(e[0])}}},i={getSessionId(){return this.getStorage("sid").then(e=>{let t;if(e){const n=e.split("-"),r=n.length;n[r-1]=parseInt(n[r-1],10)+1,t=n.join("-"),this.setStorage("sid",t)}else t=`${a.makeId(20)}-1`,this.setStorage("sid",t);return t})},getSystemInfo(){return new Promise(e=>{try{const t=jd.getSystemInfoSync();e({mct:t.brand,dvc:t.model,osp:t.platform,osv:t.system,scr:t.pixelRatio,apv:t.version,mnv:t.SDKVersion,scw:t.screenWidth,sch:t.screenHeight,winw:t.windowWidth,winh:t.windowHeight,sbh:t.statusBarHeight,lang:t.language,fsiz:t.fontSizeSetting})}catch(t){a.logger(t),e({})}})},getLaunchOptions(){if(jd.getLaunchOptionsSync){const e=jd.getLaunchOptionsSync();return{scene:e.scene,path:e.path}}return{}},setStorage(e,t){try{jd.setStorageSync(o+e,t)}catch(e){a.logger(e)}},getStorage(e){return new Promise((t,n)=>{jd.getStorage({key:o+e,success(e){t(e.data)},fail(){a.logger("获取网络类型失败"),t("")}})})},getNetworkType(){return new Promise((e,t)=>{jd.getNetworkType({success(t){e(t.networkType)},fail(){a.logger("获取网络类型失败"),e("")}})})},getPageInfo(){const e=getCurrentPages(),t=e.length,n=t>=1?e[t-1].route:"",r=t>=2?e[t-2].route:"";return{url:n,rp:r||n}},getSetting(){return new Promise(e=>{jd.getSetting({success(t){e(t.authSetting)},fail(){a.logger("获取用户的当前设置出错"),e()}})})},getUserInfo(e){return new Promise(t=>{this.getSetting().then(n=>{e&&n&&n["scope.userInfo"]||t({}),jd.getUserInfo({success(e){const{userInfo:n={}}=e||{},{city:r,country:o,gender:s,province:a}=n;t({city:r,country:o,gender:s,prov:a})},fail(){a.logger("获取用户信息出错"),t({})}})})})},getLocation(e,t){return new Promise(n=>{e?t?this.getStorage("loc").then(e=>{n({loc:e})}):this.getSetting().then(e=>{e["scope.userLocation"]||(this.setStorage("loc","-"),n({loc:"-",isLoc:!0})),jd.getLocation({type:"wgs84",success:e=>{const t=`${e.longitude}|${e.latitude}`;this.setStorage("loc",t),n({loc:t,isLoc:!0})},fail:()=>{a.logger("获取地理位置信息出错"),this.setStorage("loc","-"),n({loc:"-",isLoc:!0})}})}):(this.setStorage("loc","-"),n({loc:"-"}))})},getTitle(e){let t="";if(__jdConfig.tabBar&&(__jdConfig.tabBar.list.find(n=>{return n.pathPath!==e&&n.pagePath!==`${e}.html`||n&&n.text&&(t=n.text),!0}),0===t.length)){const n=__jdConfig.page[e]||__jdConfig.page[`${e}.html`];t=n&&n.window.navigationBarTitleText?n.window.navigationBarTitleText:__wxConfig.global.window.navigationBarTitleText}return t},request(r,o,s,i){const c=a.compile(JSON.stringify(i),s);a.logger("req",r,i);const{testCode:g,reqTest:l}=this.isRequestTestURL();if(jd.request({url:`${e}/${n[r]}`,data:{appKey:o,data:c},method:"POST"}),l){const e=i;e.monitorId=g,e.reqType=r,a.logger("reqTest",r,i),jd.request({url:t,data:e,method:"POST"})}},isRequestTestURL(){return new Promise(e=>{jd.getClipboardData({success:t=>{if(t.data.length>19&&"❧"===t.data[0]&&"❧"===t.data[t.data.length-1]){const n=t.data.split("❧").join(""),r=a.makeKey("miniprogram"),o=a.uncompile(n,r);-1!==o.search("QD")&&19===o.length&&(a.logger("开启奇点测试:",`code:${o}`),jd.setClipboardData({data:""}),e({testCode:o,reqTest:!0}))}},fail(){e({})}})})}};let c;c=i;var g={...c};const l=require("./qd-config.js"),p=Object.prototype.hasOwnProperty,h={...l,seq:0,shareId:0};let d=!1;const u={};function f(e){const t={param:{}};t.ex1=h.shareId;const n=Object.keys(e);return n.forEach(n=>{return"function"!==typeof e[n]&&("title"===n?t.ex2=e[n]:"path"===n?t.ex3=e.path:t.param[n]=e[n],!1)}),t}function m(){h.seq+=1}function y(){h.shareId+=1}function S(e=!1){let t=!1;const{url:n,rp:r}=g.getPageInfo();e?t=!0:!0!==u[n]&&(t=!0),t&&(h.url=n,h.rp=r,u[n]=!0,h.tle=g.getTitle(n))}function w(e){"object"===typeof e&&Object.keys(e).forEach(t=>{h[t]=e[t],t in r&&g.setStorage(t,e[t])})}function j(e,t){const n=t,o=Object.keys(e);return o.forEach(t=>{t in n&&(n[t]=e[t],t in r&&g.setStorage(t,e[t]))}),t}function I(...e){if(e.length>=1&&e[0]){const t=e[0];r.forEach(e=>{p.call(t,e)&&""!==t[e]&&(g.setStorage(e,t[e]),h[e]=t[e])})}return new Promise(t=>{Promise.all([g.getNetworkType(),g.getUserInfo(h.userInfo),g.getLocation(h.location,d)]).then(([n,r,o])=>{h.net=n,Object.assign(h,r),Object.assign(h,o),d=o.isLoc;const s={sessionId:h.sid||"",appKey:h.appKey||"",appId:h.appId||"",unionId:h.unionId||"",pin:h.pin||"",openId:h.openId||"",ex1:e[0]&&p.call(e[0],"ex1")?e[0].ex1:"",ex2:e[0]&&p.call(e[0],"ex2")?e[0].ex2:"",ex3:e[0]&&p.call(e[0],"ex3")?e[0].ex3:"",ctm:(new Date).getTime()};t(s)})})}function b(...e){const{scene:t,path:n}=g.getLaunchOptions();I().then(r=>{let o={appName:h.appName||"",net:h.net||"",osv:h.osv||"",osp:h.osp||"",dvc:h.dvc||"",mct:h.mct||"",scr:h.scr||"",apv:h.apv||"",phn:h.phn||"",loc:h.loc||"",gender:h.gender||"",city:h.city||"",prov:h.prov||"",country:h.country||"",spath:n||"",src:t||"",scw:h.scw||"",sch:h.sch||"",winw:h.winw||"",winh:h.winh||"",sbh:h.sbh||"",lang:h.lang||"",fsiz:h.fsiz||"",wpv:h.wpv||""};Object.assign(o,r),e[0]&&(o=j(e[0],o)),g.request("app",h.appKey,h.reqKey,o)})}function v(...e){m(),S(!0),I(e[0]).then(t=>{let n={seq:h.seq,url:h.url,referPath:h.rp||"-",tle:h.tle};Object.assign(n,t),e[0]&&(n=j(e[0],n)),g.request("page",h.appKey,h.reqKey,n)})}function q(e,t){S(),I(t).then(n=>{let r={typ:e,url:h.url,eid:t.eid||"",ela:t.ela||"",eli:t.eli||"",param:JSON.stringify(t.param)||"",rtm:(new Date).getTime()};Object.assign(r,n),g.request("event",h.appKey,h.reqKey,r)})}function C(e="",t={}){let n={};const r={...t};switch(e){case"share":y(),n=f(r),q("share_0",n);break;case"success":n.ex1=h.shareId,n.param=r,q("share_1",n);break;case"fail":n.ex1=h.shareId,n.param=r,q("share_2",n);break;default:break}}function T(){g.getSessionId().then(e=>{h.sid=e}),h.reqKey=a.makeKey(h.appSecret)||"",g.getSystemInfo().then(e=>{Object.assign(h,e)})}var x={init:T,startApp:b,startPage:v,startEvent:q,startShare:C,setData:w},O={init(){x.init()},startApp(...e){x.startApp(e[0])},startPage(...e){x.startPage(e[0])},startEvent(e,t){x.startEvent(e,t)},setData(e){x.setData(e)},startShare(e,t){x.startShare(e,t)}};export default O;
